# Use the official Python image from the Docker Hub
FROM python:3.9-slim

# Set environment variables
ENV PYTHONDONTWRITEBYTECODE 1
ENV PYTHONUNBUFFERED 1

# Set work directory
WORKDIR /app

# Install dependencies
COPY server/requirements.txt .
RUN pip install -r requirements.txt

# Copy project
COPY server/ .

# Accept build arguments for secrets
ARG ENVIRONMENT

ARG EMAIL_FROM
ARG ALLOWED_HOSTS
ARG ALLOWED_ORIGINS
ARG REDIS_URL
ARG SENDGRID_API_KEY
ARG SENDGRID_TEMPLATE_ID_PASSWORD_RESET_OTP
ARG VIDEO_SDK_CALL_WEBHOOK
ARG VIDEO_SDK_CALL_DURATION_LIMIT

ARG VIDEO_SDK_TOKEN
ARG DATABASE_URL
ARG VIDEO_SDK_PUBLIC_KEY

# Set environment variables
ENV DEBUG=True
ENV ENVIRONMENT=$ENVIRONMENT
ENV EMAIL_FROM=$EMAIL_FROM
ENV ALLOWED_HOSTS=$ALLOWED_HOSTS
ENV ALLOWED_ORIGINS=$ALLOWED_ORIGINS
ENV REDIS_URL=$REDIS_URL
ENV SENDGRID_API_KEY=$SENDGRID_API_KEY
ENV SENDGRID_TEMPLATE_ID_PASSWORD_RESET_OTP=$SENDGRID_TEMPLATE_ID_PASSWORD_RESET_OTP
ENV VIDEO_SDK_CALL_WEBHOOK=$VIDEO_SDK_CALL_WEBHOOK
ENV VIDEO_SDK_CALL_DURATION_LIMIT=$VIDEO_SDK_CALL_DURATION_LIMIT

ENV VIDEO_SDK_TOKEN=$VIDEO_SDK_TOKEN
ENV DATABASE_URL=$DATABASE_URL
ENV VIDEO_SDK_PUBLIC_KEY=$VIDEO_SDK_PUBLIC_KEY


COPY entrypoint.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh

# Expose the port the app runs on
EXPOSE 8000

# Define the command to run the app
ENTRYPOINT [ "/entrypoint.sh" ]